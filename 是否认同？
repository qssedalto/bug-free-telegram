import SwiftUI

fileprivate extension String {
    static let incrementNKey = "incrementN"
    static let dateKey = "dateKey"
}

struct ContentView: View {
    @State private var showConfirmation = false
    @State private var developerForgives = false
    @State private var showImmediatelyRecognize = false
    @State private var n: Int
    
    @State private var showDisagree = false
    
    @State private var bgColor: Color = .white
    
    init() {
        self.showDisagree = false
        self.showConfirmation = false
        self.developerForgives = false
        var n = UserDefaults.standard.integer(forKey: .incrementNKey)
        n = (n == 0 ? 7 : n)
        
        let timestamp = UserDefaults.standard.double(forKey: .dateKey)
        let lastDate: Date
        if timestamp == 0 {
            lastDate = Date()
        }
        else {
            lastDate = Date(timeIntervalSince1970: timestamp)
        }
        let today = Date()
        let diff: DateComponents = Calendar.current.dateComponents([.second], from: lastDate, to: today)
        let day = diff.second ?? 0
        
        if day > 5 {
            n += 1
        }
        
        
        self.n = n
        print(n)
        
        
        DispatchQueue.global().async {
            UserDefaults.standard.set(n, forKey: .incrementNKey)
            UserDefaults.standard.set(today.timeIntervalSince1970, forKey: .dateKey)
        }
    }
    
    var body: some View {
        NavigationView {
            VStack {
                Spacer()
                
                Text("æ˜¯å¦è®¤åŒç„¦æ™¨é˜³æ˜¯å¤§å‚»é€¼ï¼Ÿ")
                    .font(.title)
                    .bold()
                    .multilineTextAlignment(.center)
                    .padding()
                
                Spacer()
                
                Button(action: {
                    showConfirmation = true
                }) {
                    Text("è®¤åŒ")
                        .font(.body)
                        .foregroundColor(.white)
                        .frame(width: 120, height: 40)
                        .background(Color.blue)
                        .cornerRadius(8)
                }
                .padding()
                
                Button(action: {
                    
                    showImmediatelyRecognize = true
                }) {
                    Text("éå¸¸è®¤åŒ")
                        .font(.body)
                        .foregroundColor(.white)
                        .frame(width: 120, height: 40)
                        .background(Color.green)
                        .cornerRadius(8)
                }
                .padding()
                
                Button(action: {
                    bgColor = .red
                    showDisagree = true
                }) {
                    Text("ä¸è®¤åŒ")
                        .font(.body)
                        .foregroundColor(.white)
                        .frame(width: 120, height: 40)
                        .background(Color.red)
                        .cornerRadius(8)
                }
                .padding()
                
                Spacer()
            }
            .navigationBarTitle("å¼€å‘è€…ã®é—®é¢˜ğŸ™‹", displayMode: .large)
            .sheet(isPresented: $showConfirmation) {
                //                ConfirmationView(developerForgives: $developerForgives, showConfirmation: $showConfirmation, a: calculateA())
                ConfirmationView(showConfirmation: $showConfirmation, a: calculateA())
            }
            //            .onReceive(timer) { _ in
            //                incrementN()
            //            }
            .sheet(isPresented: $showImmediatelyRecognize) {
                ImmediatelyRecognizeView()
            }
            .sheet(isPresented: $showDisagree) {
                DisagreeView(bgColor: $bgColor)
            }
            .frame(maxWidth: .infinity, maxHeight: .infinity)
            .background(bgColor)
        }
        .navigationViewStyle(.stack)
    }
    
    func calculateA() -> Int {
        //        let a = Int((686 * pow(1.05, Double(n - 3))) + (70 * pow(1.05, Double(n - 1))) + (49 * pow(1.05, Double(n - 4))) + (21 * pow(1.05, Double(n - 5))))
        let result = lround((686 * pow(1.05, Double(n - 3))) + (70 * pow(1.05, Double(n - 1))) + (49 * pow(1.05, Double(n - 4))) + (21 * pow(1.05, Double(n - 5))))
        print(result)
        let a = Int(result)
        return max(a, 0)
    }
    
    //    func incrementN() {
    //        // åœ¨æ¯å¤©é›¶ç‚¹åè‡ªåŠ¨å¢åŠ nçš„å€¼
    //        n += 1
    //    }
    
    //    let timer = Timer.publish(every: 24 * 60 * 60, on: .main, in: .common).autoconnect()
}

struct ConfirmationView: View {
    //    @Binding var developerForgives: Bool
    @State private var developerForgives: Bool = false
    @Binding var showConfirmation: Bool
    var a: Int
    
    var body: some View {
        VStack {
            Text("ä½ æ€ä¹ˆèƒ½ä»…ä»…è¿™æ ·è®¤ä¸ºå‘¢ï¼Ÿ")
                .font(.title)
                .bold()
                .padding()
            
            Spacer()
            
            Button(action: {
                //                developerForgives = true
                //                showConfirmation = false
                
                if developerForgives {
                    showConfirmation = false
                }
                else {
                    // æ˜¾ç¤ºä»·æ ¼
                    developerForgives = true
                }
            }) {
                Text("å¯¹ä¸èµ·")
                    .font(.body)
                    .foregroundColor(.white)
                    .frame(width: 120, height: 40)
                    .background(Color.purple)
                    .cornerRadius(8)
            }
            .padding()
            
            if developerForgives {
                Text("å¼€å‘è€…åŸè°…ä½ äº†ï¼Œè¯·ä½ ååŠ©å¼€å‘è€…å‘ç„¦æ™¨é˜³ç´¢è¦åˆåŒæ¬ æ¬¾\(a)å…ƒï¼Œå¼€å‘è€…å‘ä½ é“è°¢ï¼")
                    .font(.title)
                    .bold()
                    .padding()
            }
            
            Spacer()
        }
    }
}

struct ImmediatelyRecognizeView: View {
    //    @Binding var developerForgives: Bool
    @State private var showText: Bool = false
    
    @Environment(\.dismiss) var dismiss
    
    //    @Environment(\.presentationMode) var presentationMode
    
    var body: some View {
        VStack {
            Text("ä½ çš„è§‚ç‚¹éå¸¸èµ")
                .font(.title)
                .bold()
                .padding()
            
            Spacer()
            
            Button(action: {
                if showText {
                    // é€€å‡º
                    dismiss()
                    //                    presentationMode.wrappedValue.dismiss()
                }
                else {
                    
                    showText = true
                }
            }) {
                Text("æ­£ç¡®çš„")
                    .font(.body)
                    .foregroundColor(.white)
                    .frame(width: 120, height: 40)
                    .background(Color.purple)
                    .cornerRadius(8)
            }
            .padding()
            
            if showText {
                Text("é‚£ä¹ˆè¯·ä½ å°è¯•æŒ‰ä¸€ä¸‹ä¸è®¤åŒæŒ‰é’®")
                    .font(.title)
                    .bold()
                    .padding()
            }
            
            Spacer()
        }
    }
}

struct DisagreeView: View {
    @Binding var bgColor: Color
    @State private var showText: Bool = false
    
    @Environment(\.dismiss) var dismiss
    
    //    @Environment(\.presentationMode) var presentationMode
    
    var body: some View {
        VStack {
            Text("è­¦å‘Šâš ï¸ä½ å·²è¢«SCP-â™¾ï¸ ç„¦æ™¨é˜³ è¿½æ€ï¼è¯·å°½å¿«é€ƒç¦»ï¼")
                .font(.title)
                .bold()
                .padding()
            
            Spacer()
            
            Button(action: {
                bgColor = .white
                dismiss()
            }) {
                Text("é€ƒç¦»")
                    .font(.body)
                    .foregroundColor(.white)
                    .frame(width: 120, height: 40)
                    .background(Color.purple)
                    .cornerRadius(8)
            }
            .padding()
            
            if showText {
                Text("é‚£ä¹ˆè¯·ä½ å°è¯•æŒ‰ä¸€ä¸‹ä¸è®¤åŒæŒ‰é’®")
                    .font(.title)
                    .bold()
                    .padding()
            }
            
            Spacer()
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
        .background(bgColor)
    }
}

@main
struct DarkModeDemoApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}

